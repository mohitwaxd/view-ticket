<div class="container">
  <h1 class="title">Telecrm Ticketing</h1>

  <!-- Ticket Preview Mode (when ticket_id is provided) -->
  @if (ticketId) {
    <div class="ticket-preview-container">
      @if (isLoadingTicket) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading ticket preview...</p>
        </div>
      } @else if (ticketPreview) {
        <div class="ticket-preview">
          <div class="ticket-header">
            <div class="ticket-title-section">
              <h2 class="ticket-subject">{{ ticketPreview.subject }}</h2>
              <div class="ticket-meta">
                <span class="ticket-id">Ticket #{{ ticketPreview.id }}</span>
                <span class="ticket-status" [class]="'status-' + ticketPreview.status.toLowerCase()">
                  {{ ticketPreview.status }}
                </span>
                @if (ticketPreview.priority) {
                  <span class="ticket-priority">{{ ticketPreview.priority }}</span>
                }
                <span class="ticket-date">Created: {{ formatDate(ticketPreview.created_at) }}</span>
              </div>
            </div>
          </div>

          <div class="ticket-description">
            <h3>Description</h3>
            <div class="description-content" [innerHTML]="ticketPreview.description || 'No description available'"></div>
          </div>

          @if (ticketComments.length > 0) {
            <div class="ticket-comments">
              <h3>Comments ({{ ticketComments.length }})</h3>
              <div class="comments-list">
                @for (comment of ticketComments.slice(0, 3); track comment.id) {
                  <div class="comment-item">
                    <div class="comment-header">
                      <span class="comment-date">{{ formatDate(comment.created_at) }}</span>
                      @if (comment.public) {
                        <span class="comment-type public">Public</span>
                      } @else {
                        <span class="comment-type internal">Internal</span>
                      }
                    </div>
                    <div class="comment-body" [innerHTML]="comment.html_body || comment.body"></div>
                  </div>
                }
                @if (ticketComments.length > 3) {
                  <p class="more-comments">+ {{ ticketComments.length - 3 }} more comments</p>
                }
              </div>
            </div>
          }

          <div class="ticket-actions-sticky">
            <app-button
              label="View Full Ticket"
              (clicked)="onViewTicket()"
            ></app-button>
          </div>
        </div>
      } @else {
        <div class="error-state">
          <p>Unable to load ticket preview. Please try again or view the ticket directly.</p>
          <div class="ticket-actions-sticky">
            <app-button
              label="View Ticket"
              (clicked)="onViewTicket()"
            ></app-button>
          </div>
        </div>
      }
    </div>
  } @else {
    <!-- Normal Mode (when no ticket_id) -->
    <div class="content-container">
      <app-dropdown
        label="Select Enterprise"
        [dropdownOptions]="enterprises"
        [selectedOption]="selectedEnterprise"
        (optionSelected)="onEnterpriseSelected($event)"
        [disabled]="(enterprises && enterprises.length === 1)"
      ></app-dropdown>

      @if (createTicketMode) {
      <div class="view-tickets-btn-container">
          <button class="view-tickets-btn" (click)="onViewTickets()">
              <img src="assets/link.svg" alt="view-ticket" />
              <span>View Ticket</span>
          </button>
      </div>

        <app-dropdown
          label="Ticket Creator"
          [dropdownOptions]="ticketCreators"
          [selectedOption]="selectedTicketCreator"
          (optionSelected)="onTicketCreatorSelected($event)"
          [disabled]="!(selectedTicketCreator == null)"
        ></app-dropdown>

        <app-multi-select-dropdown
          label="Add Telecrm Team"
          [options]="customerSuccessTeamMembers"
          [selectedOptions]="selectedCustomerSuccessTeamMembers"
          (selectionChange)="onCSTeamMembersChange($event)"
        ></app-multi-select-dropdown>

        <app-multi-select-dropdown
          [label]="selectedEnterprise?.name + ' Team'"
          [options]="customerTeamMembers"
          [selectedOptions]="selectedTeamMembers"
          (selectionChange)="onCustomerTeamMembersChange($event)"
        ></app-multi-select-dropdown>
      }

      @if (!createTicketMode) {
        <div class="btn-container" id="btn-container">
          <app-button
            label="Create Ticket"
            (clicked)="onCreateTicketMode()"
            [disabled]="!selectedEnterprise"
          ></app-button>
          <app-button
            label="View Tickets"
            (clicked)="onViewTickets()"
            [disabled]="!selectedEnterprise"
          ></app-button>
        </div>
      } @else {
        <div class="footer-container" id="footer">
          <app-button
            label="Cancel"
            variant="secondary"
            (clicked)="onCancel()"
          ></app-button>
          <app-button label="Proceed" (clicked)="createTicket()"></app-button>
        </div>
      }
    </div>
  }

  <form #jwtForm action="" method="post" target="_blank" id="jwtForm">
    <input #jwtInput type="hidden" name="jwt" id="jwtInput" />
  </form>
</div>